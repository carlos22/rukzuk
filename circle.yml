machine:
  php:
    version: 5.6.22
  node:
    version: 0.10.37

dependencies:
  override:
    - npm i -g grunt-cli 
    - npm install
    - composer install:
        pwd:
          app/server
    - composer install:
        pwd:
          app/server/library
    - npm install:
        pwd:
          app/sets/rukzuk

deployment:
  release:
    tag: /0\.20[0-9]{6}\.[0-9]+\.stable/
    commands:
      - grunt build --channel=stable --build=$CIRCLE_TAG:
          pwd:
            app/sets/rukzuk
      - grunt package --channel=stable --build=$CIRCLE_TAG
      - cp artifacts/$CIRCLE_TAG.tgz $CIRCLE_ARTIFACTS
      - go get github.com/aktau/github-release
      - github-release upload --user rukzuk --repo rukzuk --tag $CIRCLE_TAG --name $CIRCLE_TAG.tgz --file artifacts/$CIRCLE_TAG.tgz
      #- bash ./notify-docker-hub.sh

  snapshot:
    branch: /.*/
    commands:
      - grunt build --channel=dev:
          pwd:
            app/sets/rukzuk
      - grunt package --channel=dev
      - mv artifacts/SNAPSHOT.tgz $CIRCLE_ARTIFACTS

test:
  override:
    - grunt test # client tests (js)
    #- $(cd app/sets/rukzuk; grunt test) # modul tests
    - grunt phpunit:all # backend tests
