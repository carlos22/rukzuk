machine:
  php:
    version: 5.6.22
  node:
    version: 0.10.37

dependencies:
  override:
    - npm i -g grunt-cli 
    - npm install
    - $(cd app/server; composer install)
    - $(cd app/server/library; composer install)

deployment:
  release:
    tag: /0\.20[0-9]{6}\.[0-9]+\.stable/
    commands:
      - grunt package --channel=stable --build=$(git describe --tags)
      - mv artifacts/$(git describe --tags).tgz $CIRCLE_ARTIFACTS
      - go get github.com/tcnksm/ghr      
      - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME v1.0.$CIRCLE_BUILD_NUM $CIRCLE_ARTIFACTS/ || true

  snapshot:
    branch: /.*/
    commands:
      - grunt package --channel=stable
      - mv artifacts/SNAPSHOT.tgz $CIRCLE_ARTIFACTS

test:
  override:
    - grunt test # client tests (js)
    #- $(cd app/sets/rukzuk; grunt test) # modul tests
    - grunt phpunit:all # backend tests
